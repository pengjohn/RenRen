// Application main form file.
 
// Original file name: App_RenRenMainForm.cpp
// Generated by TOPS Builder:Project wizard,Date:2010-12-13
 

 
#include  "App_RenRenMainForm.h"

#include "RenRenAPICommon.h"

#if(LCD_SIZE == LCD_HVGA )
#define DOT_X	90
#define DOT_Y	400
#elif(LCD_SIZE == LCD_WVGA )
#define DOT_X	90
#define DOT_Y	650
#endif
#define DOT_W	14
#define DOT_H	14

#define LOADING_FORM_MAX_COUNT	(30)	//拨号的最大次数

TMainForm::TMainForm(TApplication * pApp):TWindow(pApp)
{
	nLoadStep = 0;
	m_nTimerId = -1;
	Create(APP_RE_ID_MainForm);
}

TMainForm::~TMainForm()
{
	//TODO::停止定时器
	TIMER_Release(m_nTimerId);
	m_nTimerId = -1;
}

Boolean TMainForm::EventHandler(TApplication * pApp, EventType * pEvent)
{
	Boolean bHandled = FALSE;

	switch(pEvent->eType)
	{
	case EVENT_WinInit:
		{
	            bHandled = _OnWinInitEvent(pApp, pEvent);			
			bHandled = TRUE;
		}
		break;
	case EVENT_WinPaint:
		{
			DrawWindow();
			bHandled = TRUE;
		}
		break;
	case EVENT_CtrlSelect:
		{
			//switch(pEvent->sParam1)
			//{
			//case RES_SYSTEM_WINDOW_TITLE_BUTTON_ID:
			//	bHandled = TRUE;
			//	break;			
			//}

			// 处理控件点击事件或响应事件
			bHandled = _OnCtlSelectEvent( pApp, pEvent );

		}
		break;
	case EVENT_WinClose:
		{
			// Stop the application since the main form has been closed
			//pApp->SendStopEvent();
		}
		break;

	case EVENT_WinEraseClient:
		{
			TDC 	   dc(this);
			WinEraseClientEventType *pEraseEvent = reinterpret_cast< WinEraseClientEventType* >( pEvent );
			TRectangle rc(pEraseEvent->rc);
			TRectangle rcBack(5, 142, 310, 314);
			this->GetBounds(&rcBack);
		
			// 擦除
			dc.EraseRectangle(&rc, 0);
			
			dc.DrawBitmapsH(TResource::LoadConstBitmap(APP_RE_ID_BITMAP_Loading_bg), 0, 0, SCR_W, GUI_API_STYLE_ALIGNMENT_LEFT); 
	
			pEraseEvent->result = 1;				
			bHandled = TRUE;
		}
		break;		

	case EVENT_KeyCommand: 
		{ 
			// 抓取右软键事件 
			if (pEvent->sParam1 == SYS_KEY_SOFTKEY_RIGHT_UP  
				|| pEvent->sParam1 == SYS_KEY_SOFTKEY_RIGHT_LONG) 
			{ 
				// 模拟退出按钮选中消息 
				//pApp->CloseAllWindows();
				pApp->SendStopEvent();	
				bHandled = TRUE; 
			} 
		} 

		case MESSAGE_TIMER:
		{
			//容错,如果TimerID == 0, 则直接忽略
			if(pEvent->sParam1 == 0)
				break;		
			if (pEvent->sParam1 == m_nTimerId)
			{
				nLoadStep ++;
				if(nLoadStep > LOADING_FORM_MAX_COUNT)
				{
					TIMER_Release(m_nTimerId);
					m_nTimerId = -1;
					//先停止Connect Timer
					SS_GTID			gtidMain;
					SS_GetCurrentGTID(&gtidMain);
					App_PostMessageEx(&gtidMain, MSG_CONNECT_INIT_TIMEROUT, NULL, 0, 0, 0);
					
					pApp->MessageBox(TResource::LoadConstString(APP_RE_ID_STRING_DialupTimerOut), TUSTR_Re_NULL, WMB_OK);
					pApp->SendStopEvent();				
				}
				else
				{
					_DrawDot(pApp, nLoadStep%LOADING_FORM_DOT_NUM);
				}
			}
			bHandled = TRUE;
			break;
		}
	
	}
	
	if (FALSE == bHandled)
	{
		return TWindow::EventHandler(pApp,pEvent);
	}
	return bHandled;
}

Boolean TMainForm:: _OnCtlSelectEvent( TApplication * pApp,EventType * pEvent )
{
	Boolean bHandled = FALSE;
	
	return bHandled;
}

Boolean TMainForm::_OnWinInitEvent(TApplication * pApp, EventType * pEvent)
{
	for(int i=0; i<LOADING_FORM_DOT_NUM; i++)
	{
		TImage* pTImage = new TImage;
		if(pTImage->Create(this))
		{
			TRectangle obBtnRec(DOT_X+((SCR_W - DOT_X*2)/LOADING_FORM_DOT_NUM)*i, DOT_Y, DOT_W, DOT_H);
			nDotID[i] = pTImage->GetId();//save button ID
			pTImage->SetBounds(&obBtnRec); 	
			pTImage->SetBitmapByResId (APP_RE_ID_BITMAP_Loading_dot); 
		}
	}
	
	_DrawDot(pApp, nLoadStep);
	m_nTimerId = TIMER_Create(1000, TIMER_MODE_AUTORUN | TIMER_MODE_PERIOD, NULL, 0, 0);	
	return TRUE;
}

/**
 * 显示连接动画 
 *
 * \param pApp
 * \param nStep:  动画的第几步
 */
void TMainForm::_DrawDot(TApplication * pApp, int nStep)
{

	for(int i=0; i<LOADING_FORM_DOT_NUM; i++)
	{
		TImage* pTImage = NULL;
		pTImage = static_cast< TImage* >(this->GetControlPtr(nDotID[i]));
		if(pTImage!= NULL)
		{
			if(i<=nStep)
				pTImage->SetBitmapByResId (APP_RE_ID_BITMAP_Loading_dot_hl);
			else
				pTImage->SetBitmapByResId (APP_RE_ID_BITMAP_Loading_dot);
		}
	}	
	return;
}

